---
import { type CollectionEntry, getCollection, render } from "astro:content";
import { Icon } from "astro-icon/components";

import Base from "@layouts/Base.astro";
import BackLink from "@components/BackLink.astro";
import Tag from "@components/Tag.astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog", ({ data }) => {
    return !data.draft && !data.archived;
  });

  return posts.map((post, index) => ({
    params: { slug: post.id },
    props: {
      post,
      prevPost: posts[index + 1] || null,
      nextPost: posts[index - 1] || null,
    },
  }));
}

interface Props {
  post: CollectionEntry<"blog">;
  prevPost: CollectionEntry<"blog"> | null;
  nextPost: CollectionEntry<"blog"> | null;
}

const { post, prevPost, nextPost } = Astro.props;
const { Content } = await render(post);
---

<Base
  title={post.data.title}
  description={post.data.description}
  image={`/blog/${post.id}.png`}
>
  <article class="w-full max-w-2xl flex flex-col gap-8">
    <header class="flex flex-col gap-4">
      <BackLink href="/blog" label="back to blog" />
      <h1 class="text-3xl font-bold">{post.data.title}</h1>
      <div class="flex flex-wrap items-center gap-3 text-fg-lighter text-sm">
        <time datetime={post.data.date.toISOString()}>
          {post.data.date.toLocaleDateString("en-GB", {
            day: "numeric",
            month: "long",
            year: "numeric",
          })}
        </time>
        <span>·</span>
        <span>{post.data.readTime} min read</span>
        {post.data.updated && (
          <>
            <span>·</span>
            <span>
              updated {post.data.updated.toLocaleDateString("en-GB", {
                day: "numeric",
                month: "short",
                year: "numeric",
              })}
            </span>
          </>
        )}
      </div>
      <div class="flex flex-wrap gap-2">
        {post.data.tags.map((tag: string) => (
          <Tag tag={tag} />
        ))}
      </div>
    </header>

    <div class="prose">
      <Content />
    </div>

    <section class="flex flex-col gap-4 pt-8 border-t border-card">
      <h2 class="text-lg font-medium">share this post</h2>
      <div class="flex flex-row gap-4">
        <a
          href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(post.data.title)}&url=${encodeURIComponent(`https://isabelroses.com/blog/${post.id}`)}`}
          target="_blank"
          rel="noopener noreferrer"
          class="share-icon"
          aria-label="Share on Twitter"
        >
          <Icon name="fa7-brands:x-twitter" class="w-5 h-5" />
        </a>
        <a
          href={`https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(`https://isabelroses.com/blog/${post.id}`)}&title=${encodeURIComponent(post.data.title)}`}
          target="_blank"
          rel="noopener noreferrer"
          class="share-icon"
          aria-label="Share on LinkedIn"
        >
          <Icon name="fa7-brands:linkedin" class="w-5 h-5" />
        </a>
        <button
          id="copy-link"
          class="share-icon cursor-pointer relative"
          aria-label="Copy link"
        >
          <Icon name="fa7-solid:link" class="w-5 h-5 copy-icon transition-all duration-200" />
          <Icon name="fa7-solid:check" class="w-5 h-5 check-icon absolute inset-0 opacity-0 scale-0 transition-all duration-200" />
        </button>
      </div>
    </section>

    <nav class="flex flex-col sm:flex-row justify-between gap-4 pt-8 border-t border-card">
      {prevPost ? (
        <a
          href={`/blog/${prevPost.id}`}
          class="group flex flex-col gap-1 p-4 bg-card rounded-lg hover:ring-1 hover:ring-special transition-all flex-1"
        >
          <span class="text-fg-lighter text-sm">← previous</span>
          <span class="group-hover:text-special transition-colors">
            {prevPost.data.title}
          </span>
        </a>
      ) : (
        <div class="flex-1" />
      )}
      {nextPost ? (
        <a
          href={`/blog/${nextPost.id}`}
          class="group flex flex-col gap-1 p-4 bg-card rounded-lg hover:ring-1 hover:ring-special transition-all flex-1 text-right"
        >
          <span class="text-fg-lighter text-sm">next →</span>
          <span class="group-hover:text-special transition-colors">
            {nextPost.data.title}
          </span>
        </a>
      ) : (
        <div class="flex-1" />
      )}
    </nav>
  </article>

  <script>
    document.addEventListener("astro:page-load", () => {
      const copyButton = document.getElementById("copy-link");
      copyButton?.addEventListener("click", async () => {
        await navigator.clipboard.writeText(window.location.href);
        
        const linkIcon = copyButton.querySelector(".copy-icon");
        const checkIcon = copyButton.querySelector(".check-icon");
        
        // Animate out the link icon
        linkIcon?.classList.add("opacity-0", "scale-0");
        linkIcon?.classList.remove("opacity-100", "scale-100");
        
        // Animate in the check icon
        checkIcon?.classList.remove("opacity-0", "scale-0");
        checkIcon?.classList.add("opacity-100", "scale-100", "text-green-500");
        
        // Reset after 2 seconds
        setTimeout(() => {
          checkIcon?.classList.add("opacity-0", "scale-0");
          checkIcon?.classList.remove("opacity-100", "scale-100", "text-green-500");
          linkIcon?.classList.remove("opacity-0", "scale-0");
          linkIcon?.classList.add("opacity-100", "scale-100");
        }, 2000);
      });
    });
  </script>
</Base>